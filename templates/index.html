{% extends "base.html" %}
{% block content %}

<!-- ═══════════════ MATRIX CANVAS ═══════════════ -->
<canvas id="matrix-canvas"></canvas>

<!-- ═══════════════ STOCK TICKER ═══════════════ -->
<div class="stock-ticker" id="stock-ticker">
    <div class="ticker-track" id="ticker-track"></div>
</div>

<!-- ═══════════════ HEADER ═══════════════ -->
<header>
    <div class="container">
        <div class="header-brand">
            <span class="header-brand-text">OriginOS</span>
        </div>
        <div class="logo-area">
            <img src="/logo.png" alt="OriginOS" onerror="this.style.display='none'">
        </div>
        <div class="header-actions">
            <span id="header-user-display" style="display:none;color:var(--green);font-size:12px;font-family:var(--font-mono);"></span>
            <button id="header-logout-btn" class="secondary small" onclick="headerLogout()" style="display:none;">Logout</button>
            <button id="header-login-btn" class="secondary small" onclick="document.getElementById('header-login-bar').style.display=document.getElementById('header-login-bar').style.display==='flex'?'none':'flex'">Login</button>
            <input type="file" id="csv-import-input" class="csv-input" accept=".csv">
            <button class="secondary small" onclick="document.getElementById('csv-import-input').click()" title="Import CSV">&#8593; Import</button>
            <button class="secondary small" onclick="exportCSV()" title="Export CSV">&#8595; Export</button>
            <button class="primary" id="add-prospect-btn">+ Add Prospect</button>
            <a href="mailto:tylr.roper@gmail.com?subject=Bug%20or%20New%20Feature%20Suggestion%3A%20OriginOS" class="bug-report-btn" title="Report Bug or Suggest Feature" style="position:relative;">
                &#128027;
                <span class="bug-tooltip">Report Bug / Suggest Feature</span>
            </a>
        </div>
    </div>
</header>

<!-- ═══════════════ LOGIN BAR ═══════════════ -->
<div id="header-login-bar" class="header-login-bar" style="display:none;">
    <div class="container" style="display:flex;align-items:center;gap:8px;justify-content:center;padding:8px 0;">
        <input type="text" id="header-login-user" placeholder="Username" class="login-input" style="background:var(--bg-elevated);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:var(--radius);font-size:12px;font-family:var(--font-mono);width:140px;">
        <input type="email" id="header-login-email" placeholder="Email (register only)" class="login-input" style="background:var(--bg-elevated);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:var(--radius);font-size:12px;font-family:var(--font-mono);width:180px;">
        <input type="password" id="header-login-pass" placeholder="Password" class="login-input" style="background:var(--bg-elevated);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:var(--radius);font-size:12px;font-family:var(--font-mono);width:140px;" onkeydown="if(event.key==='Enter')headerLogin()">
        <button class="primary small" onclick="headerLogin()">Login</button>
        <button class="secondary small" onclick="headerRegister()">Register</button>
    </div>
</div>

<!-- ═══════════════ XP BAR ═══════════════ -->
<div class="xp-bar-section">
    <div class="xp-container" id="xp-container">
        <div class="xp-level-badge">
            <div class="xp-trophy" id="xp-trophy">&#127942;</div>
            <div class="xp-level-name tier-bronze" id="xp-level-name">Rookie</div>
        </div>
        <div class="xp-progress-area">
            <div class="xp-progress-header">
                <span class="xp-total" id="xp-total">0 XP</span>
                <span class="xp-next" id="xp-next">Next: 100 XP</span>
            </div>
            <div class="xp-bar">
                <div class="xp-bar-fill tier-bronze" id="xp-bar-fill" style="width: 0%"></div>
            </div>
            <div class="xp-recent-action" id="xp-recent-action"></div>
        </div>
    </div>
</div>

<!-- ═══════════════ THE SAUCE ═══════════════ -->
<div class="sauce-section">
    <div class="sauce-header">
        <h3><span>&#127798;</span> // The Sauce - Buy Signal Alerts</h3>
        <button class="secondary small sauce-refresh-btn" onclick="loadSauceAlerts(true)">Refresh</button>
    </div>
    <div class="sauce-grid" id="sauce-grid">
        <div class="sauce-empty">Loading buy signals...</div>
    </div>
</div>

<!-- ═══════════════ NEWS (Side-by-Side) ═══════════════ -->
<div class="news-section">
    <div class="news-columns">
        <div class="news-column">
            <div class="news-column-header">// Financial News</div>
            <div class="news-scroll" id="financial-news-scroll">
                <div class="news-scroll-inner" id="financial-news-inner"></div>
            </div>
        </div>
        <div class="news-column">
            <div class="news-column-header">// Top News</div>
            <div class="news-scroll" id="top-news-scroll">
                <div class="news-scroll-inner" id="top-news-inner"></div>
            </div>
        </div>
    </div>
</div>

<!-- ═══════════════ TRENDING TWEETS ═══════════════ -->
<div class="tweets-section">
    <div class="tweets-grid">
        <div class="tweet-column">
            <div class="tweet-column-header"><span class="x-logo">&#120143;</span> Politics</div>
            <div class="tweet-scroll" id="tweets-politics">
                <div class="tweet-scroll-inner" id="tweets-politics-inner"></div>
            </div>
        </div>
        <div class="tweet-column">
            <div class="tweet-column-header"><span class="x-logo">&#120143;</span> Finance</div>
            <div class="tweet-scroll" id="tweets-finance">
                <div class="tweet-scroll-inner" id="tweets-finance-inner"></div>
            </div>
        </div>
        <div class="tweet-column">
            <div class="tweet-column-header"><span class="x-logo">&#120143;</span> Crypto</div>
            <div class="tweet-scroll" id="tweets-crypto">
                <div class="tweet-scroll-inner" id="tweets-crypto-inner"></div>
            </div>
        </div>
        <div class="tweet-column">
            <div class="tweet-column-header"><span class="x-logo">&#120143;</span> Global Econ</div>
            <div class="tweet-scroll" id="tweets-global">
                <div class="tweet-scroll-inner" id="tweets-global-inner"></div>
            </div>
        </div>
    </div>
</div>

<!-- ═══════════════ MAIN CONTENT ═══════════════ -->
<div class="container">
    <!-- Stats -->
    <div class="stats reveal">
        <div class="stat-card">
            <div class="stat-number" id="total-count">0</div>
            <div class="stat-label">Prospects</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="leads-count">0</div>
            <div class="stat-label">New Leads</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="pipeline-value">$0</div>
            <div class="stat-label">Pipeline</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="won-count">0</div>
            <div class="stat-label">Won Deals</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="tasks-count">0</div>
            <div class="stat-label">Pending Tasks</div>
        </div>
    </div>

    <!-- Analytics Dashboard -->
    <div class="analytics-section reveal" id="analytics-section">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
            <h3 style="margin:0;">// Analytics</h3>
            <button class="secondary small" onclick="loadAnalytics()">Refresh</button>
        </div>
        <div class="charts-grid">
            <div class="chart-card">
                <h4>Pipeline Funnel</h4>
                <canvas id="funnel-chart"></canvas>
            </div>
            <div class="chart-card">
                <h4>Deals Over Time (30d)</h4>
                <canvas id="timeline-chart"></canvas>
            </div>
            <div class="chart-card">
                <h4>Conversion Rates</h4>
                <canvas id="conversion-chart"></canvas>
            </div>
            <div class="chart-card">
                <h4>Activity (30d)</h4>
                <canvas id="activity-chart"></canvas>
            </div>
        </div>
    </div>

    <!-- Firecrawl -->
    <div class="firecrawl-section reveal">
        <h3>// AI-Powered Prospect Discovery</h3>
        <p>Firecrawl integration - scrape company websites to auto-detect prospects</p>

        <div class="crawl-options">
            <div class="radio-group">
                <label><input type="radio" name="crawlType" value="scrape" checked> Scrape Page</label>
                <label><input type="radio" name="crawlType" value="crawl"> Crawl Website</label>
            </div>
            <div class="input-row">
                <div class="input-group">
                    <label for="crawl-url">Target URL</label>
                    <input type="url" id="crawl-url" placeholder="https://company.com/team" />
                </div>
                <div class="input-group" id="crawl-limit-group">
                    <label for="crawl-limit">Pages</label>
                    <input type="number" id="crawl-limit" value="10" min="1" max="50" style="width: 80px;" />
                </div>
                <button onclick="runFirecrawl()" id="crawl-btn" class="crawl-btn">SCAN</button>
            </div>
        </div>
        <div id="crawl-status" class="crawl-status"></div>
    </div>

    <!-- Tasks Section -->
    <div class="tasks-global-section reveal" id="tasks-section">
        <h3>// Tasks & Reminders</h3>
        <div class="add-task-form">
            <div class="input-group">
                <label>Task</label>
                <input type="text" id="new-task-title" placeholder="Follow up with..." />
            </div>
            <div class="input-group">
                <label>Due Date</label>
                <input type="date" id="new-task-date" />
            </div>
            <div class="input-group">
                <label>Prospect</label>
                <div class="prospect-search-wrapper">
                    <input type="text" class="prospect-search-input" id="new-task-prospect-search" placeholder="Search or type General..." autocomplete="off" />
                    <input type="hidden" id="new-task-prospect" value="" />
                    <div class="prospect-search-dropdown" id="prospect-search-dropdown"></div>
                </div>
            </div>
            <button class="primary small" onclick="addGlobalTask()">Add</button>
        </div>
        <div id="global-tasks-list"></div>
    </div>

    <!-- Bulk Actions Bar -->
    <div id="bulk-actions" class="bulk-actions">
        <span class="bulk-actions-count"><span id="selected-count">0</span> selected</span>
        <button class="secondary small" onclick="clearSelection()">Clear</button>
        <button class="primary small" onclick="addSelectedProspects()">Add to Pipeline</button>
    </div>

    <!-- Search -->
    <div class="search-section reveal">
        <h3>// Search Database</h3>
        <div style="display: grid; grid-template-columns: 1fr auto; gap: 8px;">
            <input type="text" id="search-input" placeholder="Search name, company, title, email..." />
            <button class="secondary" onclick="searchProspects()">Search</button>
        </div>
    </div>

    <!-- View Toggle + Filter Tabs -->
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
        <div class="view-toggle">
            <button class="view-btn active" id="list-view-btn" onclick="setView('list')">List</button>
            <button class="view-btn" id="kanban-view-btn" onclick="setView('kanban')">Kanban</button>
        </div>
        <div class="tabs" id="filter-tabs">
            <button class="tab active" onclick="filterProspects('all', this)">All</button>
            <button class="tab" onclick="filterProspects('lead', this)">Leads</button>
            <button class="tab" onclick="filterProspects('contacted', this)">Contacted</button>
            <button class="tab" onclick="filterProspects('qualified', this)">Qualified</button>
            <button class="tab" onclick="filterProspects('proposal', this)">Proposal</button>
            <button class="tab" onclick="filterProspects('won', this)">Won</button>
            <button class="tab" onclick="filterProspects('lost', this)">Lost</button>
        </div>
    </div>

    <!-- Prospects Grid (List View) -->
    <div id="prospects-container" class="prospects-grid"></div>

    <!-- Kanban Board -->
    <div id="kanban-board" class="kanban-board" style="display:none;">
        <div class="kanban-column" data-status="lead">
            <div class="kanban-column-header"><span class="stage-badge stage-lead">Lead</span><span class="kanban-count" id="kanban-count-lead">0</span></div>
            <div class="kanban-cards" id="kanban-lead"></div>
        </div>
        <div class="kanban-column" data-status="contacted">
            <div class="kanban-column-header"><span class="stage-badge stage-contacted">Contacted</span><span class="kanban-count" id="kanban-count-contacted">0</span></div>
            <div class="kanban-cards" id="kanban-contacted"></div>
        </div>
        <div class="kanban-column" data-status="qualified">
            <div class="kanban-column-header"><span class="stage-badge stage-qualified">Qualified</span><span class="kanban-count" id="kanban-count-qualified">0</span></div>
            <div class="kanban-cards" id="kanban-qualified"></div>
        </div>
        <div class="kanban-column" data-status="proposal">
            <div class="kanban-column-header"><span class="stage-badge stage-proposal">Proposal</span><span class="kanban-count" id="kanban-count-proposal">0</span></div>
            <div class="kanban-cards" id="kanban-proposal"></div>
        </div>
        <div class="kanban-column" data-status="won">
            <div class="kanban-column-header"><span class="stage-badge stage-won">Won</span><span class="kanban-count" id="kanban-count-won">0</span></div>
            <div class="kanban-cards" id="kanban-won"></div>
        </div>
        <div class="kanban-column" data-status="lost">
            <div class="kanban-column-header"><span class="stage-badge stage-lost">Lost</span><span class="kanban-count" id="kanban-count-lost">0</span></div>
            <div class="kanban-cards" id="kanban-lost"></div>
        </div>
    </div>

    <!-- Education Section -->
    <div class="education-section reveal" style="margin-top: 24px;">
        <h3>// Education & Resources</h3>
        <p>Guides, tutorials, and strategies to level up your prospecting game</p>
        <div class="education-grid" id="education-grid">
            <div class="education-card" onclick="window.open('https://x.com/tylerhires/status/2017120193365832095', '_blank')">
                <div class="edu-type">&#9654; Video Guide</div>
                <div class="edu-title">Prospecting Masterclass</div>
                <div class="edu-desc">Learn the fundamentals of effective BDM prospecting and outreach strategies.</div>
            </div>
            <div class="education-card">
                <div class="edu-type">&#128214; Guide</div>
                <div class="edu-title">Cold Outreach Templates</div>
                <div class="edu-desc">Battle-tested email and LinkedIn message templates for maximum response rates.</div>
            </div>
            <div class="education-card">
                <div class="edu-type">&#128200; Strategy</div>
                <div class="edu-title">Pipeline Management 101</div>
                <div class="edu-desc">How to organize, prioritize, and move prospects through your sales pipeline.</div>
            </div>
            <div class="education-card">
                <div class="edu-type">&#128161; How-To</div>
                <div class="edu-title">Using Firecrawl for Lead Gen</div>
                <div class="edu-desc">Step-by-step guide to scraping company websites and auto-detecting prospects.</div>
            </div>
        </div>
    </div>
</div>

<!-- ═══════════════ CLOSER'S COFFEE FORUM ═══════════════ -->
<div class="forum-section" id="forum-section">
    <div class="container">
        <div class="mesh-gradient"></div>
        <div class="forum-header">
            <h2 class="forum-title">// Closer's Coffee</h2>
            <div class="forum-auth" id="forum-auth"></div>
        </div>

        <!-- Auth Forms (hidden by default) -->
        <div id="forum-login-form" class="auth-form" style="display:none;">
            <h3 style="color:var(--green);font-family:var(--font-mono);font-size:14px;margin-bottom:12px;">Login</h3>
            <div class="form-group"><label>Username or Email</label><input type="text" id="auth-login-user" placeholder="username or email" /></div>
            <div class="form-group"><label>Password</label><input type="password" id="auth-login-pass" placeholder="password" /></div>
            <div style="display:flex;gap:8px;margin-top:8px;">
                <button class="primary small" onclick="forumLogin()">Login</button>
                <button class="secondary small" onclick="hideAuthForms()">Cancel</button>
            </div>
            <div id="auth-login-error" style="color:var(--red);font-size:11px;margin-top:6px;"></div>
        </div>

        <div id="forum-register-form" class="auth-form" style="display:none;">
            <h3 style="color:var(--green);font-family:var(--font-mono);font-size:14px;margin-bottom:12px;">Create Account</h3>
            <div class="form-group"><label>Username *</label><input type="text" id="auth-reg-user" placeholder="username (3-30 chars)" /></div>
            <div class="form-group"><label>Email *</label><input type="email" id="auth-reg-email" placeholder="email@example.com" /></div>
            <div class="form-group"><label>Password *</label><input type="password" id="auth-reg-pass" placeholder="min 6 characters" /></div>
            <div class="form-group"><label>Display Name</label><input type="text" id="auth-reg-display" placeholder="optional display name" /></div>
            <div class="form-group">
                <label>Avatar</label>
                <div class="avatar-picker" id="avatar-picker"></div>
            </div>
            <div class="form-group"><label>Signature</label><textarea id="auth-reg-sig" placeholder="Your forum signature (max 200 chars)" maxlength="200" rows="2"></textarea></div>
            <div style="display:flex;gap:8px;margin-top:8px;">
                <button class="primary small" onclick="forumRegister()">Create Account</button>
                <button class="secondary small" onclick="hideAuthForms()">Cancel</button>
            </div>
            <div id="auth-reg-error" style="color:var(--red);font-size:11px;margin-top:6px;"></div>
        </div>

        <!-- Profile Editor (hidden by default) -->
        <div id="forum-profile-editor" class="auth-form" style="display:none;">
            <h3 style="color:var(--green);font-family:var(--font-mono);font-size:14px;margin-bottom:12px;">Edit Profile</h3>
            <div class="form-group"><label>Display Name</label><input type="text" id="profile-display-name" /></div>
            <div class="form-group">
                <label>Avatar</label>
                <div class="avatar-picker" id="profile-avatar-picker"></div>
            </div>
            <div class="form-group"><label>Signature</label><textarea id="profile-signature" maxlength="200" rows="2"></textarea></div>
            <div style="display:flex;gap:8px;margin-top:8px;">
                <button class="primary small" onclick="saveProfile()">Save</button>
                <button class="secondary small" onclick="hideAuthForms()">Cancel</button>
            </div>
        </div>

        <!-- Forum Views -->
        <div id="forum-post-list"></div>
        <div id="forum-post-detail" style="display:none;"></div>
        <div id="forum-create-form" style="display:none;">
            <div class="auth-form">
                <h3 style="color:var(--green);font-family:var(--font-mono);font-size:14px;margin-bottom:12px;">New Post</h3>
                <div class="form-group"><label>Title *</label><input type="text" id="forum-new-title" placeholder="Post title" maxlength="200" /></div>
                <div class="form-group"><label>Body *</label><textarea id="forum-new-body" placeholder="Write your post..." rows="5"></textarea></div>
                <div style="display:flex;gap:8px;margin-top:8px;">
                    <button class="primary small" onclick="submitForumPost()">Post</button>
                    <button class="secondary small" onclick="showForumList()">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ═══════════════ FOOTER ═══════════════ -->
<footer class="site-footer">
    <div class="footer-glow-line"></div>
    <canvas class="footer-matrix-canvas" id="footer-matrix-canvas"></canvas>
    <div class="footer-content">
        <div class="footer-logo-area">
            <img src="/logo.png" alt="OriginOS" onerror="this.style.display='none'">
        </div>
        <div class="footer-legal">
            OriginOS&trade; &copy; 2025
        </div>
    </div>
</footer>

<!-- ═══════════════ SIDE DRAWER ═══════════════ -->
<div class="drawer-overlay" id="drawer-overlay" onclick="closeDrawer()"></div>
<div class="side-drawer" id="side-drawer">
    <div class="drawer-header">
        <h2 id="drawer-prospect-name">Prospect</h2>
        <button class="drawer-close" onclick="closeDrawer()">&#x2715;</button>
    </div>
    <div class="drawer-body" id="drawer-body"></div>
</div>

<!-- ═══════════════ ADD/EDIT MODAL ═══════════════ -->
<div id="prospect-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modal-title">Add Prospect</h2>
        </div>
        <form id="prospect-form">
            <div class="form-group">
                <label for="name">Name *</label>
                <input type="text" id="name" name="name" required />
            </div>
            <div class="form-group">
                <label for="company">Company</label>
                <input type="text" id="company" name="company" />
            </div>
            <div class="form-group">
                <label for="title">Title</label>
                <input type="text" id="title" name="title" />
            </div>
            <div class="form-group">
                <label for="email">Email <button type="button" class="email-guess-btn" onclick="guessEmail()">Guess Email</button></label>
                <input type="text" id="email" name="email" placeholder="email@example.com" />
                <div class="email-guess-container" id="email-guess-container"></div>
            </div>
            <div class="form-group">
                <label for="phone">Phone</label>
                <input type="tel" id="phone" name="phone" placeholder="(555) 123-4567" />
            </div>
            <div class="form-group">
                <label for="status">Status</label>
                <select id="status" name="status">
                    <option value="lead">Lead</option>
                    <option value="contacted">Contacted</option>
                    <option value="qualified">Qualified</option>
                    <option value="proposal">Proposal</option>
                    <option value="won">Won</option>
                    <option value="lost">Lost</option>
                </select>
            </div>
            <div class="form-group">
                <label for="deal-size">Deal Size ($)</label>
                <input type="number" id="deal-size" name="deal-size" min="0" value="0" />
            </div>
            <div class="form-group">
                <label for="linkedin-url">LinkedIn URL</label>
                <input type="text" id="linkedin-url" name="linkedin-url" placeholder="linkedin.com/in/..." />
            </div>
            <div class="form-group">
                <label for="source-url">Source URL</label>
                <input type="text" id="source-url" name="source-url" placeholder="Where you found this prospect" />
            </div>
            <div class="form-group">
                <label for="notes">Notes</label>
                <textarea id="notes" name="notes" placeholder="Additional notes..."></textarea>
            </div>
            <div id="duplicate-alert" class="duplicate-alert" style="display:none;">
                <div class="duplicate-alert-header">&#9888; Possible Duplicates Found</div>
                <div id="duplicate-matches"></div>
            </div>
            <div class="modal-actions">
                <button type="button" class="secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="primary">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- ═══════════════ TASK MODAL ═══════════════ -->
<div id="task-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add Task</h2>
        </div>
        <form id="task-form" onsubmit="handleTaskFormSubmit(event)">
            <div class="form-group">
                <label>Task Title *</label>
                <input type="text" id="task-title-input" required />
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="task-desc-input" placeholder="Optional details..."></textarea>
            </div>
            <div class="form-group">
                <label>Due Date *</label>
                <input type="date" id="task-date-input" required />
            </div>
            <input type="hidden" id="task-prospect-id-input" />
            <div class="modal-actions">
                <button type="button" class="secondary" onclick="closeTaskModal()">Cancel</button>
                <button type="submit" class="primary">Add Task</button>
            </div>
        </form>
    </div>
</div>

<!-- ═══════════════ CHAT WIDGET ═══════════════ -->
<div class="chat-widget" id="chat-widget">
    <div class="chat-window" id="chat-window">
        <div class="chat-header">
            <h4>// LIVE CHAT</h4>
            <span class="chat-online"><span class="chat-online-dot"></span><span id="chat-online-count">0</span> online</span>
        </div>
        <div id="chat-username-setup" class="chat-username-prompt">
            <p>Choose your username</p>
            <input type="text" id="chat-username-input" placeholder="Enter username..." maxlength="20" />
            <button class="primary small" onclick="setChatUsername()" style="width: 100%;">Join Chat</button>
        </div>
        <div id="chat-main" style="display: none; flex: 1; flex-direction: column;">
            <div class="chat-messages" id="chat-messages"></div>
            <div class="chat-input-area">
                <input type="text" id="chat-msg-input" placeholder="Type a message..." maxlength="500" />
                <button onclick="sendChatMessage()">Send</button>
            </div>
        </div>
    </div>
    <div style="position: relative;">
        <button class="chat-toggle" onclick="toggleChat()">&#9993;</button>
        <div class="chat-badge" id="chat-badge">0</div>
    </div>
</div>

{% endblock %}
